# å‘å¸ƒå·¥ä½œæµ
# å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒåˆ° GitHub Release

name: Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v2.1.0 ç­‰ç‰ˆæœ¬æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    permissions:
      contents: write  # å…è®¸å†™å…¥ GitHub Release
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
          # Windows æ„å»ºé…ç½®
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            name: 'Windows'
          # macOS Intel æ„å»ºé…ç½®
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'macOS Intel'
          # macOS Apple Silicon æ„å»ºé…ç½®
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'macOS Apple Silicon'
          # Linux æ„å»ºé…ç½®
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
            name: 'Linux'

    runs-on: ${{ matrix.platform }}
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # å®‰è£… Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      # å®‰è£… Linux ä¾èµ–
      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libjavascriptcoregtk-4.1-dev libsoup-3.0-dev

      # å®‰è£…å‰ç«¯ä¾èµ–
      - name: Install frontend dependencies
        run: npm install

      # ä½¿ç”¨ Tauri Action æ„å»ºåº”ç”¨
      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'æ‰«é›·æ¸¸æˆ ${{ github.ref_name }}'
          releaseBody: |
            ## æ‰«é›·æ¸¸æˆ ${{ github.ref_name }}

            ### ä¸‹è½½è¯´æ˜
            - **Windows ç”¨æˆ·**: ä¸‹è½½ `.msi` æˆ– `.exe` æ–‡ä»¶
            - **macOS Intel ç”¨æˆ·**: ä¸‹è½½ `x64.dmg` æ–‡ä»¶
            - **macOS Apple Silicon ç”¨æˆ·**: ä¸‹è½½ `aarch64.dmg` æ–‡ä»¶
            - **Linux ç”¨æˆ·**: ä¸‹è½½ `.AppImage` æˆ– `.deb` æ–‡ä»¶

            ### å®‰è£…è¯´æ˜
            - **Windows**: è¿è¡Œå®‰è£…ç¨‹åºï¼ŒæŒ‰æç¤ºå®Œæˆå®‰è£…
            - **macOS**: æ‰“å¼€ DMG æ–‡ä»¶ï¼Œå°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            - **Linux**: è¿è¡Œ AppImage æˆ–å®‰è£… deb åŒ…

            ### åŠŸèƒ½ç‰¹æ€§
            - ğŸ® ç»å…¸æ‰«é›·ç©æ³•
            - ğŸŒ ä¸­è‹±æ–‡ç•Œé¢åˆ‡æ¢
            - ğŸ¯ å¤šéš¾åº¦çº§åˆ«ï¼ˆåˆçº§ã€ä¸­çº§ã€é«˜çº§ã€è‡ªå®šä¹‰ï¼‰
            - ğŸ† æ¸¸æˆç»Ÿè®¡å’Œæ’è¡Œæ¦œ
            - ğŸ”Š éŸ³æ•ˆæ”¯æŒ

            ### ç³»ç»Ÿè¦æ±‚
            - Windows 10/11
            - macOS 11+ (Intel æˆ– Apple Silicon)
            - Ubuntu 20.04+ / Debian 11+
          releaseDraft: true  # å…ˆåˆ›å»ºè‰ç¨¿ï¼Œæ–¹ä¾¿æ‰‹åŠ¨ç¼–è¾‘
          prerelease: false
          args: ${{ matrix.args }}

  # æ›´æ–° README ä¸­çš„ç‰ˆæœ¬å·
  update-readme:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update README with release info
        run: |
          VERSION=${{ github.ref_name }}
          echo "Updating README for version $VERSION"
          # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨æ›´æ–° README ç‰ˆæœ¬çš„è„šæœ¬

  # é€šçŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  notify:
    needs: [build, update-readme]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼"
          else
            echo "âŒ éƒ¨åˆ†å¹³å°æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
